var SV=window.SV||{};SV.AdvancedBBCode=SV.AdvancedBBCode||{};SV.AdvancedBBCode.EditorConfig=SV.AdvancedBBCode.EditorConfig||[];SV.AdvancedBBCode.EditorInit=SV.AdvancedBBCode.EditorInit||[];SV.$=SV.$||window.jQuery||null;
(function(G,E,H){const e=SV.$;e&&(XF.Editor=XF.extend(XF.Editor,{__backup:{normalizePaste:"svAdvancedBbCode_normalizePaste"},normalizePaste:function(b){b=e("<div />").html(b);var g=[];b.find("[data-fr-sv-class]").each(function(){var a=e(this);a.addClass(a.attr("data-fr-sv-class"));a.removeAttr("data-fr-sv-class")});SV.AdvancedBBCode.editorConfig.tags.abbr&&b.find("abbr").replaceWith(function(){var a=""+e(this).attr("title");return"[ABBR"+(a.length?'="'+a+'"':"")+"]"+this.innerHTML+"[/ABBR]"});if(SV.AdvancedBBCode.editorConfig.shimH1){var d=
SV.AdvancedBBCode.editorConfig.hrStyle;b.find("hr:not(.bbc-hr)").addClass("bbc-hr"+(d?" bbc-hr--"+d:""));d=b.find("sub, sup, h1, h2, h3, h4");0!==d.length&&(g="SVBBCODE_SUB SVBBCODE_SUP SVBBCODE_H1 SVBBCODE_H2 SVBBCODE_H3 SVBBCODE_H4".split(" "),d.replaceWith(function(){var a=e("<SVBBCODE_"+this.tagName+" />");a.html(this.innerHTML);a.addClass(this.className);return a}))}b=b.html();b=this.svAdvancedBbCode_normalizePaste(b);0!==g.length&&(b=e("<div />").html(b),g=g.join(", "),b.find(g).replaceWith(function(){var a=
this.tagName.replace("SVBBCODE_",""),l=e("<"+a+" />");l.html(this.innerHTML);l.addClass(this.className);switch(a){case "H1":case "H2":case "H3":case "H4":l.hasClass("bbc-header")||l.addClass("bbc-header")}return l}),b=b.html());return b}}),SV.AdvancedBBCode.copyNPaste={setupFragWrapper:function(b,g,d,a){g&&(b=SV.AdvancedBBCode.copyNPaste.cleanupQuoteCharactersCopyPaste(b));b=e.parseHTML(b);b=e("<div />").html(b);if(a){const n="object"===typeof a;let t="",w=e('<iframe id="ClassToInlineStyleImporter" style="position: absolute;width:0;height:0;border:0;"></iframe>');
try{w.html(b.html());w.appendTo(e("body"));var l=[];e.uniqueSort(w.find("p, span, hr, [class]")).each(function(r,f){r={};var c=G.getComputedStyle(f);if(0!==c.length){for(var h=c.length;h--;){var k=c[h];if(!n||k in a){var x=c.getPropertyValue(k);""!==x&&(r[k]=x)}}0!==r.length&&l.push([e(f),r])}});for(g=0;g<l.length;g++){var p=l[g][0],m=l[g][1],q=p.attr("style");p.css(m);q&&p.attr("style",p.attr("style")+";"+q)}t=w.html()}catch(r){console.log(r)}w.remove();""!==t&&(b=e("<div />").html(t))}d&&(b.contents().filter(function(){return this.nodeType===
Node.COMMENT_NODE}).remove(),b.find("> xml, > meta, > style, > link, > title").remove(),b=SV.AdvancedBBCode.copyNPaste.setupFragWrapper(b.html().trim()));return b},cleanupQuoteCharactersCopyPaste:function(b){return b=b.replace(/&#x2018;|&#x2019;|[\u2018-\u201B]/gi,"'").replace(/&#x201C;|&#x201D;|[\u201C-\u201F\u301D-\u301F\u2E42]/gi,'"').replace(/&nbsp;|&ensp;|&emsp;|&thinsp;|&#x200[0-9A];|&#x202F;|&#x205F;|&#x3000;|[\u2000-\u200A\u202F\u205F\u3000]/gi," ")},cleanupWordNewlinesCopyPaste:function(b){b.find('span[lang], span[style*="mso-ansi-language"], span[style*="mso-fareast-language"]').each(function(g,
d){g=e(d);g.replaceWith(g.html())});b.find("div hr").each(function(g,d){e(d).unwrap()});b.children("p.MsoNoSpacing,p.MsoNormal").each(function(g,d){g=e(d);var a=e("<span />");a.attr("style",g.attr("style"));g.contents().each(function(){this.nodeType!==Node.COMMENT_NODE&&"O:P"!==this.tagName||e(this).remove()});a.html(g.html());a.addClass(d.className);SV.AdvancedBBCode.copyNPaste.appendBrForSpanRewrite(a,0);var l=""+d.style.marginBottom;""!==l?.1<SV.AdvancedBBCode.copyNPaste.getAttrLineHeightPercent(d,
l,0)?(d.style.marginBottom="",d.style.marginTop="",d=1):d=0:d=a.hasClass("MsoNormal");d&&0<a.length&&a.append(e("<br>"));g.replaceWith(a)});return b},appendBrForSpanRewrite:function(b,g=0,d=1){for(var a=b.get(0).childNodes,l=a.length-1;0<=l;l--){var p=a[l];if(p.nodeType!==Node.TEXT_NODE||p.nodeValue&&!/^[\s\n]+$/.test(p.nodeValue)){d="BR"!==p.tagName;break}}d&&(g&&0<a.length&&b.append(e("<br>")),b.append(e("<br>")))},getAttrLineHeightPercent:function(b,g,d){g=g?g:d+"%";var a=g.match(/^(\d+(?:\.\d+)?)px$/);
a&&a[1]?(d=parseFloat(a[1]),g=""+b.style.fontSize,(a=g.match(/^(\d+)px$/))&&a[1]&&(b=parseFloat(a[1]),d=100*d/b|0)):(a=g.match(/^(\d+)%$/))&&a[1]&&(d=a[1]|0);return d},cleanupLibreOfficeNewlinesCopyPaste:function(b,g){b.find('p > img[src*="gallery/rulers"]').each(function(d,a){d=e(a);/file:\/\/.*\/gallery\/rulers\/.*.gif/i.test(d.attr("src"))&&(a=e("<hr />"),a.attr("style",d.attr("style")),d.replaceWith(a))});b.children("p").each(function(d,a){var l=SV.AdvancedBBCode.copyNPaste.getAttrLineHeightPercent(a,
a.style.lineHeight,100);if(l){d=e(a);var p=e("<span />");a.style.lineHeight="";p.attr("style",d.attr("style"));p.html(d.html());SV.AdvancedBBCode.copyNPaste.appendBrForSpanRewrite(p,0);l>=g&&200>l&&(l=200);for(a=Math.floor(l/100)|0;1<a;)a--,p.append(e("<br>"));d.replaceWith(p)}});b.children("hr").each(function(d,a){if(d=SV.AdvancedBBCode.copyNPaste.getAttrLineHeightPercent(a,a.style.lineHeight,100))for(a=e(a),115<=d&&200>d&&(d=200),d=Math.floor(d/100)|0;1<d;)d--,a.after(e("<br>"))});return b},cleanupOpenOfficeNewlinesCopyPaste:function(b){b.children('span[style*="margin"]').each(function(g,
d){g=""+d.style.marginBottom;""!==g&&57.5<=SV.AdvancedBBCode.copyNPaste.getAttrLineHeightPercent(d,g,0)&&(d.style.marginBottom="",d.style.marginTop="",e(d).append(e("<br>")))});return b},cleanupHtmlCopyPaste:function(b,g,d){var a=b.find("pre code.hljs");a.each(function(f,c){var h=e(c);f=h.parent();c=e("<span />");var k=h.attr("class").match(/.*\s+hljs\s+([^\s]+)$/i);k=k?"="+k[1]:"";c.attr("style",h.attr("style")+";"+f.attr("style"));c.text(h.text());h=e('<p data-xf-p="1" />');h.append("[code"+k+"]\n");
h.append(c);h.append("[/code]");f.replaceWith(h)});a=b.find("code.inline, code.bbCodeInline");a.each(function(f,c){f=e(c);c=e("<span />");c.attr("style",f.attr("style"));c.text("[icode]"+f.text()+"[/icode]");f.replaceWith(c)});a=b.find('span[class*="spoilerText"][aria-expanded] > span[aria-hidden], span.bbCodeInlineSpoiler, span.bbc-spoiler');a.each(function(f,c){f=e(c);f.removeClass("bbc-spoiler bbc-spoiler-instant");f.prepend("[ispoiler]");f.append("[/ispoiler]")});a=e.uniqueSort(b.find('.message-name .username[itemprop="name"], .username[itemprop="name"]'));
a.each(function(f,c){f=e(c);c=f.parent();var h=f.text(),k=e("<span />");h=h.replace(/^@/,"");h=(f.data("user-id")|0?"@":"")+h+" ";k.text(h);c.hasClass("message-name")?c.replaceWith(k):f.replaceWith(k)});a=b.find("h1, h2, h3, h4, h5, h6");a.each(function(f,c){f=e(c);c=c.tagName;if("H5"===c||"H6"===c)c="H4";var h=e("<span />");h.attr("style",f.attr("style"));h.html(f.html().replace(/^\n+/,""));var k=e('<p data-xf-p="1" />');k.append("["+c+"]");k.append(h);k.append("[/"+c+"]");f.replaceWith(k)});if(SV.AdvancedBBCode.editorConfig.tags.fa){var l=
"fa-rotate-90 fa-rotate-180 fa-rotate-270 fa-flip-horizontal fa-flip-vertical fa-flip-both fa-spin fa-pulse fa-fw".split(" ");SV.AdvancedBBCode.editorConfig.tags.fa.forEach(function(f){b.find("i."+f).replaceWith(function(){var c=e(this).attr("class").toLowerCase().split(/\s+/);var h="";var k=[];h=c.indexOf(f);-1<h&&c.splice(h,1);l.forEach(function(x){var A=c.indexOf(x);-1<A&&(k.push(x),c.splice(A,1))});if(1!==c.length)return this;h=c[0].replace(/^fa-/,"");0!==k.length&&(h=h+" "+k.join(" "));return"["+
f+'="'+h+'"][/'+f+"]"+this.innerHTML})})}SV.AdvancedBBCode.editorConfig.pasteQuotesAsBbCode&&(a=b.find("blockquote"),a.each(function(f,c){f=e(c);c=e("<span class='blockquote-span' />");c.attr("style",f.attr("style"));c.html(f.html());var h=e('<p data-xf-p="1" />');h.append("[QUOTE]\n");h.append(c);h.append("[/QUOTE]");f.replaceWith(h)}));a=b.find("span.Apple-converted-space");a.each(function(f,c){f=e(c);"&nbsp;"===f.html()&&f.replaceWith(" ")});a=b.find("p, span, div, blockquote, code");a.each(function(f,
c){f=e(c);var h=[];var k=c.style.fontWeight;c.style.fontWeight="";(700<=Number(k)||"bold"===k)&&h.push("strong");if(!f.parent("pre").length){k=c.style.whiteSpace;if(""===k&&(f.is("blockquote")||f.hasClass("blockquote-span"))&&(k=f.css("white-space"),""===k)){var x=f.parent('[style*="white-space:"]').first();x.length&&(k=x.get(0).style.whiteSpace)}if(/^pre(-.*)?$|^break-spaces$/i.test(k)){c.style.whiteSpace="";var A=function(u){if(u.hasChildNodes()){var v=u.childNodes;for(let z=0;z<v.length;z++){var y=
v[z];if(y.hasChildNodes())A(y);else if(y.nodeType===Node.TEXT_NODE&&y.nodeValue){var B=y.nodeValue.split(/\r?\n/);1<B.length&&(B.forEach(function(C,D){C=E.createTextNode(C);u.insertBefore(C,y);z++;D+1<B.length&&(D=E.createElement("br"),u.insertBefore(D,y),z++)}),u.removeChild(y),z--)}}}};c.normalize();A(c)}}k=c.style.fontStyle;c.style.fontStyle="";/^italic|^oblique/i.test(k)&&h.push("em");k=c.style.textDecoration;c.style.textDecoration="";"line-through"===k?h.push("s"):"underline"===k&&h.push("u");
k=c.style.verticalAlign;c.style.verticalAlign="";"super"===k?h.push("sup"):"sub"===k&&h.push("sub");k=c.style.textAlign;c=c.style.textAlign="";switch(k){case "center":c="center";break;case "end":case "right":c="right"}""!==c&&(f.prepend("<span>["+c+"]</span>"),f.append("<span>[/"+c+"]</span>"));if(h.length){var F=f;e.each(h,function(u,v){Array.isArray(v)?(u=v[0],v=v[1]):(u=v,v="");F=F.wrapInner("<"+u+" "+v+"></"+u+">")})}});b.find("[data-fr-sv-class]").removeAttr("data-fr-sv-class");b.find('[class*="bbc-"]').each(function(){var f=
this.className.match(/(bbc-[^\s]+)/gi);0!==f.length&&e(this).attr("data-fr-sv-class",f.join(" "))});d&&b.find('p[style*="margin-top:1pt"]').each(function(){"1pt"!==this.style.marginTop||"1pt"!==this.style.marginBottom||this.nextElementSibling&&"BR"!==this.nextElementSibling.tagName||(this.style.marginTop=0,this.style.marginBottom=0)});if(!g)return b;g=b.get(0);d=g.childNodes;if(1<d.length){a=!0;for(var p=!1,m=[],q=d.length-1;0<=q;q--){var n=d[q];if(n.nodeType===Node.COMMENT_NODE)m.push(n);else if(n.nodeType!==
Node.TEXT_NODE||n.nodeValue&&!/^[\s\n]+$/.test(n.nodeValue))if("STYLE"===n.tagName||"META"===n.tagName||"LINK"===n.tagName||"TITLE"===n.tagName||"XML"===n.tagName)m.push(n);else{var t=n.childNodes;if("P"!==n.tagName&&"HR"!==n.tagName)n=!1;else{n=!1;for(var w=t.length-1;0<=w;w--){var r=t[w];if(r.nodeType!==Node.COMMENT_NODE&&(r.nodeType!==Node.TEXT_NODE||r.nodeValue&&!/^[\s\n]+$/.test(r.nodeValue))){"BR"===r.tagName&&(p=!0);n=!0;break}}}if(!n){a=!1;break}}else m.push(n)}if(a&&p){for(q in m)g.removeChild(m[q]);
b.children("p").attr("data-xf-p","1")}}return b}},SV.AdvancedBBCode.EditorInit.push(function(b,g,d,a){g.events.on("paste.beforeCleanup",function(m){var q=!1,n=!1,t=SV.AdvancedBBCode.editorConfig.normalizeQuoteChars;/class="?Mso|class='?Mso|class="?Xl|class='?Xl|class=Xl|style="[^"]*\bmso-|style='[^']*\bmso-|w:WordDocument/i.test(m)?(m=SV.AdvancedBBCode.copyNPaste.setupFragWrapper(m,t,!0,{"margin-bottom":1,"margin-top":1}),m=SV.AdvancedBBCode.copyNPaste.cleanupWordNewlinesCopyPaste(m)):/<meta[^>]+?LibreOffice/i.test(m)?
(m=SV.AdvancedBBCode.copyNPaste.setupFragWrapper(m,t,!0,!0),m=SV.AdvancedBBCode.copyNPaste.cleanupLibreOfficeNewlinesCopyPaste(m,115)):/<meta[^>]+?OpenOffice/i.test(m)?(m=SV.AdvancedBBCode.copyNPaste.setupFragWrapper(m,t,!0,!0),m=SV.AdvancedBBCode.copyNPaste.cleanupLibreOfficeNewlinesCopyPaste(m,141),m=SV.AdvancedBBCode.copyNPaste.cleanupOpenOfficeNewlinesCopyPaste(m)):(m=SV.AdvancedBBCode.copyNPaste.setupFragWrapper(m,t,!1),q=m.children('[id*="docs-internal-guid-"]'),(n=1===q.length&&0===m.children("p,hr").length&&
0<q.children("p,hr,br").length)&&q.children().unwrap(),q=!0);m=SV.AdvancedBBCode.copyNPaste.cleanupHtmlCopyPaste(m,q,n);return m=m.html()},!0);var l=(b=(d.target||d.$target.get(0)).dataset.debugCopyPasteOutput)?e(b):null;if(null!==l&&0!==l.length){var p=e('input[type="checkbox"][name="showCopyAndPasteDebugging"]');p.change(function(){this.checked?l.show():l.hide()});g.events.on("paste.beforeCleanup",function(m){/^\s+$/i.test(m)?(l.hide(),l.empty()):(l.empty(),l.append("<hr>"),l.append(e("<pre style='word-wrap:break-word;white-space:pre-wrap;' />").text(m)),
l.append("<hr>"),(0===p.length||p.get(0).checked)&&l.show());return m},!0);g.events.on("contentChanged",function(){var m=g.opts.wordCounterGetText?g.opts.wordCounterGetText():g.el.innerText||"";/^\s+$/i.test(m)&&(l.hide(),l.empty())})}}))})(window,document);
